SELECT
    -- üîë Keys
    PRSCDT.SPHMLCT,
    PRSCDT.PRSCNO,
    PRSCDT.ITEMNO,
    PRSCDT.PACKSEQ,

    -- üë§ Patient Info
    PRSC.HN,
    PRSC.AN,
    PRSC.VN,
    PRSC.PTTYPE,

    -- üè• Visit Info
    PRSC.PRSCDATE,
    PRSC.PRSCTIME,
    PRSC.PRFRLCT,
    OVST.VSTTIME,
    OVST.CLINICLCT,

    -- üíä Medication Info
    PRSCDT.MEDITEM,
    PRSCDT.QTY,
    MEDITEMDIS.MEDCODE,
    MEDITEMDIS.MEDFORM,
    MEDITEMDIS.MALE,

    -- üßæ Usage Instructions
    PRSCDT.MEDUSETYPE,
    MEDUSETYPE.NAME AS MEDUSETYPE_NAME,

    PRSCDT.MEDUSEQTY,
    MEDUSEQTY.NAME AS MEDUSEQTY_NAME,

    PRSCDT.MEDUSEUNIT,
    MEDUSEUNIT.NAME AS MEDUSEUNIT_NAME,

    PRSCDT.MEDUSETIME,
    MEDUSETIME.NAME AS MEDUSETIME_NAME,

    PRSCDT.MEDSYMPTOM,
    MEDSYMPTOM.NAME AS MEDSYMPTOM_NAME,


    -- üì¶ Order Details
    PRSCDT.ICSALE,
    PRSCDT.ORDERCODE,
    PRSCDT.INCOME,
    PRSCDT.PRSCDTEXT,
    PRSCDT.PTTYPEEXT,

    -- üßæ Dispensing / Order Metadata
    PRSC.PRSCTYPEPT,
    PRSC.PRSCST,
    PRSC.TOTALITEM,
    PRSC.PRSCAMT,
    PRSC.TYPE_OF_ORDER,
    PRSC.RUNNING_NO,
    PRSC.FINLCT,
    PRSC.FINREFNO,

    -- üìÜ Timestamps
    PRSC.CONFIRMDATE,
    PRSC.CONFIRMTIME,
    PRSC.CHKDATE,
    PRSC.CHKTIME,
    PRSC.OTPDATE,
    PRSC.OTPTIME,
    PRSC.RCVDATE,
    PRSC.CANCELDATE,

    -- üë®‚Äç‚öïÔ∏è Staff & Locations
    PRSCDT.ISSUESTF,
    PRSC.C_PHLOC,

    -- üïí Audit Columns
    PRSCDT.FIRSTDATE,
    PRSC.STATUS

FROM {{ source('ddc_internal', 'PRSCDT') }} PRSCDT

LEFT JOIN {{ source('ddc_internal', 'PRSC') }} PRSC
    ON PRSC.PRSCNO = PRSCDT.PRSCNO
   AND PRSC.SPHMLCT = PRSCDT.SPHMLCT

LEFT JOIN (
    SELECT
        HN,
        VSTDATE,
        MIN(VSTTIME) AS VSTTIME,
        CLINICLCT
    FROM {{ source('ddc_internal', 'OVST') }}
    GROUP BY HN, VSTDATE, CLINICLCT
) OVST
    ON PRSC.HN = OVST.HN
   AND PRSC.PRSCDATE = OVST.VSTDATE
   AND PRSC.PRFRLCT = OVST.CLINICLCT

LEFT JOIN {{ source('ddc_internal', 'MEDITEMDIS') }} MEDITEMDIS
    ON PRSCDT.MEDITEM = MEDITEMDIS.MEDITEM

LEFT JOIN {{ source('ddc_internal', 'MEDUSEQTY') }} MEDUSEQTY
    ON PRSCDT.MEDUSEQTY = MEDUSEQTY.MEDUSEQTY

LEFT JOIN {{ source('ddc_internal', 'MEDUSETYPE') }} MEDUSETYPE
    ON PRSCDT.MEDUSETYPE = MEDUSETYPE.MEDUSETYPE
   AND MEDITEMDIS.MEDFORM = MEDUSETYPE.MEDFORM

LEFT JOIN {{ source('ddc_internal', 'MEDUSEUNIT') }} MEDUSEUNIT
    ON PRSCDT.MEDUSEUNIT = MEDUSEUNIT.MEDUSEUNIT

LEFT JOIN {{ source('ddc_internal', 'MEDUSETIME') }} MEDUSETIME
    ON PRSCDT.MEDUSETIME = MEDUSETIME.MEDUSETIME

LEFT JOIN {{ source('ddc_internal', 'MEDSYMPTOM') }} MEDSYMPTOM
    ON PRSCDT.MEDSYMPTOM = MEDSYMPTOM.MEDSYMPTOM
