SELECT
LVSTEXM.HN
, DATEADD(SECOND, CAST(LVSTEXM.LVSTTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(LVSTEXM.LVSTTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(LVSTEXM.LVSTTIME AS INT) / 10000, LVSTEXM.LVSTDATE)
    )
) AS LVSTDATETIME
, LABGRP.NAME AS GROUP_NAME
, LVSTEXM.LABEXM
, LABEXM.NAME AS LAB_NAME
, LVSTEXM.RESULT
, LVSTEXM.MINNRM
, LVSTEXM.MAXNRM
, LVSTEXM.NRMUNIT
, LABEXM.HCODE
, LABEXM.ORDERCODE
, LVSTEXM.ITEMNO
, LVSTEXM.AN
, LVSTEXM.LN
, LVSTEXM.LABLCT
, LCT1.NAME AS LAB_LOCATION_NAME
, LABSPCM.NAME AS SPECIMEN
, LVST.LRFRLCT
, LCT2.NAME AS LAB_ORDERED_LOCATION_NAME
, LVST.DCT
, LVST.RQTDATE
, LVST.LVSTST
-- , LSVTST.NAME
, LVSTEXM.PRICE
, LVSTEXM.FIRSTDATE
, LVSTEXM.OPRTLCT
, LCT3.NAME AS PROCEDURAL_LOCATION_NAME
, LVSTEXM.FINLCT
, LCT4.NAME AS PAYMENT_LOCATION_NAME
, LVSTEXM.FINREFNO
, LVST.RCPTLCT
, LCT5.NAME AS CASHIER_LOCATION_NAME
, LVST.CANCELDATE
, CULTURE_BAC_MED_SENS.NAME1 AS BAC_NAME
, CULTURE_BAC_MED_SENS.HCODE AS BAC_HCODE
, CULTURE_BAC_MED_SENS.QTY1 AS BAC_QTY
, CULTURE_BAC_MED_SENS.NAME AS MED_NAME
, CULTURE_BAC_MED_SENS.SENS_MED_HCODE
, CULTURE_BAC_MED_SENS.SENSITIVITY
, CULTURE_BAC_MED_SENS.MIC
, CULTURE_BAC_MED_SENS.UNIT
FROM {{ source('ddc_internal', 'LVSTEXM') }} LVSTEXM
LEFT JOIN {{ source('ddc_internal', 'LABEXM') }} LABEXM ON LABEXM.LABEXM = LVSTEXM.LABEXM
LEFT JOIN {{ source('ddc_internal', 'LABGRP') }} LABGRP ON LABGRP.LABGRP = LVSTEXM.LABGRP
LEFT JOIN {{ source('ddc_internal', 'LABSPCM') }} LABSPCM ON LABSPCM.LABSPCM = LVSTEXM.LABSPCM
LEFT JOIN {{ source('ddc_internal', 'LVST') }} LVST ON LVST.HN = LVSTEXM.HN AND LVST.LVSTDATE = LVSTEXM.LVSTDATE AND LVST.LVSTTIME = LVSTEXM.LVSTTIME AND LVST.LABGRP = LVSTEXM.LABGRP AND LVST.LABNO = LVSTEXM.LABNO
-- LEFT JOIN {{ source('ddc_internal', 'LCT') }} LVSTST ON LVST.LVSTST = LVSTST.LVSTST
LEFT JOIN {{ source('ddc_internal', 'LCT') }} LCT1 ON LCT1.LCT = LVSTEXM.LABLCT
LEFT JOIN {{ source('ddc_internal', 'LCT') }} LCT2 ON LCT2.LCT = LVST.LRFRLCT
LEFT JOIN {{ source('ddc_internal', 'LCT') }} LCT3 ON LCT3.LCT = LVSTEXM.OPRTLCT
LEFT JOIN {{ source('ddc_internal', 'LCT') }} LCT4 ON LCT4.LCT = LVSTEXM.FINLCT
LEFT JOIN {{ source('ddc_internal', 'LCT') }} LCT5 ON LCT5.LCT = LVST.RCPTLCT
OUTER APPLY (
    SELECT
    -- LABORGANISM_ITA.NAME1 AS BAC_NAME
    -- , LABORGANISM_ITA.HCODE AS BAC_HCODE
    -- , LABORGANQTY_ITA.QTY1 AS BAC_QTY
     LABMEDICINE.NAME AS MED_NAME
    , LABMEDICINE.HCODE AS SENS_MED_HCODE
    , LVSTEXMBAC2.CMED_INT AS SENSITIVITY
    , LVSTEXMBAC2.MIC
    , LABMEDICINE.UNIT
    FROM {{ source('ddc_internal', 'LVSTEXMBAC1') }} LVSTEXMBAC1
    -- LEFT JOIN {{ source('ddc_internal', 'LCT') }} LABORGANISM_ITA ON LABORGANISM_ITA.ORGANISM = LVSTEXMBAC1.ORGANISM
    -- LEFT JOIN {{ source('ddc_internal', 'LCT') }} LABORGANQTY_ITA ON LABORGANQTY_ITA.ORGANQTY = LVSTEXMBAC1.ORGANQTY
    LEFT JOIN {{ source('ddc_internal', 'LVSTEXMBAC2') }} LVSTEXMBAC2 ON LVSTEXMBAC2.LABGRP = LVSTEXMBAC1.LABGRP AND LVSTEXMBAC2.LABNO = LVSTEXMBAC1.LABNO AND LVSTEXMBAC2.LABEXM = LVSTEXMBAC1.LABEXM AND LVSTEXMBAC2.SEQNO = LVSTEXMBAC1.SEQNO
    LEFT JOIN {{ source('ddc_internal', 'LABMEDICINE') }} LABMEDICINE ON LABMEDICINE.MEDICINE = LVSTEXMBAC2.LMEDICINE
    WHERE LVSTEXMBAC1.LABGRP = LVSTEXM.LABGRP
    AND LVSTEXMBAC1.LABNO = LVSTEXM.LABNO
    AND LVSTEXMBAC1.LABEXM = LVSTEXM.LABEXM
) CULTURE_BAC_MED_SENS
WHERE LVST.CANCELDATE IS NULL






