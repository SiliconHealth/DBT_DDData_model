SELECT 
OVST.HN
, DATEADD(SECOND, CAST(OVST.VSTTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.VSTTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.VSTTIME AS INT) / 10000, OVST.VSTDATE)
    )
) AS VSTDATETIME
, CLINICLCT.HCODE
, CLINICLCT.DSPNAME AS CLINIC_NAME
, CLINICLCT.CLINICTYPE
, OVST.AN
, OVST.VN
, OVST.DCT
, OVSTIST.NAME AS IN_STATUS_NAME
, OVSTOST.NAME AS OUT_STATUS_NAME
, OVST.WEIGHT
, OVST.HEIGHT
, DATEADD(SECOND, CAST(OVST.NEXTTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.NEXTTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.NEXTTIME AS INT) / 10000, OVST.NEXTDATE)
    )
) AS NEXTDATETIME
, OVST.OAPPNO
, WSKIOSKVISITID_GROUPPED.KIOSKDATE
, NURSE_MAIN_CALL.CALLDATETIME AS NURSE_CALL_DATETIME
, DATEADD(SECOND, CAST(OVST.REGTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.REGTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.REGTIME AS INT) / 10000, OVST.REGDATE)
    )
) AS REGDATETIME
, DATEADD(SECOND, CAST(OVST.ITVTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.ITVTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.ITVTIME AS INT) / 10000, OVST.ITVDATE)
    )
) AS HISTORY_TAKING_DATETIME
, DATEADD(SECOND, CAST(OVST.SNDDCTTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.SNDDCTTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.SNDDCTTIME AS INT) / 10000, OVST.SNDDCTDATE)
    )
) AS SNDDCTDATETIME
, DOCTOR_CALL.CALLDATETIME AS DOCTOR_CALL_DATETIME
, DATEADD(SECOND, CAST(OVST.MTDCTTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.MTDCTTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.MTDCTTIME AS INT) / 10000, OVST.MTDCTDATE)
    )
) AS MEET_DCT_DATETIME
, DATEADD(SECOND, CAST(OVST.CMPDCTTIME AS INT) % 100, 
    DATEADD(MINUTE, (CAST(OVST.CMPDCTTIME AS INT) / 100) % 100, 
        DATEADD(HOUR, CAST(OVST.CMPDCTTIME AS INT) / 10000, OVST.CMPDCTDATE)
    )
) AS COMPLETE_DISCHARGE_DATETIME
, OVST.AGE
, OVST.AGEFLAG
, OVST.FIRSTDATE
, OVST.CANCELDATE
FROM {{ source('ddc_internal', 'OVST') }} OVST
LEFT JOIN {{ source('ddc_internal', 'CLINICLCT') }} CLINICLCT ON CLINICLCT.CLINICLCT = OVST.CLINICLCT
LEFT JOIN {{ source('ddc_internal', 'OVSTIST') }} OVSTIST ON OVSTIST.OVSTIST = OVST.OVSTIST
LEFT JOIN {{ source('ddc_internal', 'OVSTOST') }} OVSTOST ON OVSTOST.OVSTOST = OVST.OVSTOST
OUTER APPLY (
    SELECT 
        MIN(WSKIOSKVISITID.KIOSKDATE) AS KIOSKDATE
    FROM {{ source('ddc_internal', 'WSKIOSKVISITID') }} WSKIOSKVISITID
    WHERE WSKIOSKVISITID.HN = OVST.HN
      AND WSKIOSKVISITID.CLINICLCT = OVST.CLINICLCT
      AND CAST(WSKIOSKVISITID.KIOSKDATE AS DATE) = OVST.VSTDATE
) AS WSKIOSKVISITID_GROUPPED
OUTER APPLY (
    SELECT 
        MAX(DATEADD(SECOND, CAST(OPDLEDCALL.CALLTIME AS INT) % 100, 
            DATEADD(MINUTE, (CAST(OPDLEDCALL.CALLTIME AS INT) / 100) % 100, 
                DATEADD(HOUR, CAST(OPDLEDCALL.CALLTIME AS INT) / 10000, OPDLEDCALL.CALLDATE)
            )
        )) AS CALLDATETIME
    FROM {{ source('ddc_internal', 'OPDLEDCALL') }} OPDLEDCALL
    WHERE OPDLEDCALL.HN = OVST.HN
      AND OPDLEDCALL.VSTDATE = OVST.VSTDATE
      AND OPDLEDCALL.VSTTIME = OVST.VSTTIME
      AND OPDLEDCALL.CLINICLCT = OVST.CLINICLCT
      AND OPDLEDCALL.CANCELDATE IS NULL
) AS NURSE_MAIN_CALL
OUTER APPLY (
    SELECT 
        MAX(DATEADD(SECOND, CAST(OPDLEDDCTPT.CALLTIME AS INT) % 100, 
            DATEADD(MINUTE, (CAST(OPDLEDDCTPT.CALLTIME AS INT) / 100) % 100, 
                DATEADD(HOUR, CAST(OPDLEDDCTPT.CALLTIME AS INT) / 10000, OPDLEDDCTPT.CALLDATE)
            )
        )) AS CALLDATETIME
    FROM {{ source('ddc_internal', 'OPDLEDDCTPT') }} OPDLEDDCTPT
    WHERE OPDLEDDCTPT.HN = OVST.HN
      AND OPDLEDDCTPT.VSTDATE = OVST.VSTDATE
      AND OPDLEDDCTPT.VSTTIME = OVST.VSTTIME
      AND OPDLEDDCTPT.CLINICLCT = OVST.CLINICLCT
      AND OPDLEDDCTPT.CANCELDATE IS NULL
) AS DOCTOR_CALL
WHERE
OVST.CANCELDATE IS NULL